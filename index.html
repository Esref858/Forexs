<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forex 24s — Proqnoz</title>
<style>
  body{height:100vh;width:100vw;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#0b1e36,#04122b);color:#e6f0fa;font-family:Arial,sans-serif;}
  .panel{background:rgba(10,25,50,0.9);padding:30px;border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,0.7);max-width:900px;width:95%;text-align:center;}
  h1{font-size:2rem;margin-bottom:20px;color:#4bf;}
  .controls{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin-bottom:20px;}
  select,input{padding:10px;border-radius:10px;border:none;background:#04122b;color:#e6f0fa;font-weight:700;}
  button{padding:12px 20px;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.2s;box-shadow:0 8px 25px rgba(0,0,0,0.5);}
  button:hover{transform:scale(1.05);box-shadow:0 12px 35px rgba(0,0,0,0.7);}
  .btn-run{background:#4bf;color:#04122b;}
  .btn-auto{background:#ffb74b;color:#04122b;}
  #chart{background:#031520;padding:20px;border-radius:15px;height:300px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1rem;color:#4bff6b;margin-bottom:15px;overflow:auto;}
  #info{font-size:1.2rem;margin-bottom:10px;}
  #signal{font-size:2rem;font-weight:bold;}
  .up{color:#4bff6b;}
  .down{color:#ff4b4b;}
  .neutral{color:#f0f07a;}
</style>
</head>
<body>
<div class="panel">
  <h1>Forex 24s — Proqnoz</h1>
  <div class="controls">
    <select id="pair">
      <option value="EUR/USD">EUR/USD</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="GBP/USD">GBP/USD</option>
      <option value="AUD/USD">AUD/USD</option>
    </select>
    <select id="method">
      <option value="sma">SMA</option>
      <option value="ema">EMA</option>
    </select>
    <input id="window" type="number" value="20" min="2" max="500" placeholder="Pəncərə">
    <input id="avkey" type="text" placeholder="AlphaVantage API (istəyə bağlı)">
    <button id="run" class="btn-run">Məlumat al</button>
    <button id="auto" class="btn-auto">Avto: bağlı</button>
  </div>
  <div id="chart">Qrafik burada göstəriləcək</div>
  <div id="info">—</div>
  <div id="signal" class="neutral">—</div>
</div>

<script>
// SMA и EMA функции
function sma(arr,n){if(arr.length<n)return arr;const res=[];let sum=0;for(let i=0;i<arr.length;i++){sum+=arr[i];if(i>=n)sum-=arr[i-n];if(i>=n-1)res.push(sum/n);}return res;}
function ema(arr,n){if(arr.length<n)return arr;const k=2/(n+1);const res=[];let prev=arr.slice(0,n).reduce((a,b)=>a+b,0)/n;res.push(prev);for(let i=n;i<arr.length;i++){prev=arr[i]*k+prev*(1-k);res.push(prev);}return res;}
function toAlphaPair(pair){const [a,b]=pair.split('/');return {from:a.trim(),to:b.trim()};}

// Получение данных с exchangerate.host
async function fetchExchangerateHost(pair){
  try{
    const [base,quote]=pair.split('/').map(s=>s.trim());
    const end=new Date();
    const start=new Date(end.getTime()-5*24*60*60*1000); 
    const fmt=d=>d.toISOString().slice(0,10);
    const url=`https://api.exchangerate.host/timeseries?start_date=${fmt(start)}&end_date=${fmt(end)}&base=${quote}&symbols=${base}`;
    const r=await fetch(url);
    const j=await r.json();
    const arr=Object.keys(j.rates).map(d=>({t:new Date(d).getTime(),price:1/j.rates[d][base]}));
    arr.sort((a,b)=>a.t-b.t);
    return arr;
  }catch(e){return [];}
}

// Основная функция
const pairEl=document.getElementById('pair');
const methodEl=document.getElementById('method');
const winEl=document.getElementById('window');
const runBtn=document.getElementById('run');
const autoBtn=document.getElementById('auto');
const avKeyEl=document.getElementById('avkey');
const chart=document.getElementById('chart');
const info=document.getElementById('info');
const signalEl=document.getElementById('signal');
let auto=false, autoInterval;

async function runOnce(){
  try{
    info.textContent='Yüklənir...';
    chart.textContent='Məlumat alınır...';
    signalEl.textContent='—'; signalEl.className='neutral';

    const pair=pairEl.value;
    const method=methodEl.value;
    const requestedWin=Math.max(2,parseInt(winEl.value)||20);

    let data=await fetchExchangerateHost(pair);

    // Если данных нет, создаём тестовый массив
    if(!data || data.length===0){
      data=[];
      const N=Math.max(2,requestedWin);
      let val=1.0;
      for(let i=0;i<N;i++){
        val += (Math.random()-0.5)*0.01;
        data.push({t:Date.now()-((N-i)*3600*1000), price:val});
      }
    }

    // Подстройка окна под доступные данные
    const win=Math.min(requestedWin,data.length);
    if(win<requestedWin){
      info.textContent=`Qeyd: Pəncərə avtomatik ${win}-ə endirildi (mövcud məlumat sayına görə)`;
    }

    const prices=data.map(d=>d.price);
    let indicator=(method==='sma')?sma(prices,win):ema(prices,win);
    const lastPrice=prices[prices.length-1];
    const lastInd=indicator[indicator.length-1];
    const delta=(lastPrice-lastInd)/lastInd;
    const threshold=0.0015;

    let signal='Neytral', className='neutral';
    if(delta>threshold){signal='Yuxarı ↑'; className='up';}
    else if(delta<-threshold){signal='Aşağı ↓'; className='down';}

    chart.textContent=`Nöqtələr: ${prices.length}. Son qiymət: ${lastPrice.toFixed(6)} — Indikator(${method.toUpperCase()}, ${win}) = ${lastInd.toFixed(6)}`;
    info.innerHTML=`<b>${pair}</b>: ${lastPrice.toFixed(6)} USD → <b>${signal}</b>`;
    signalEl.textContent=signal; signalEl.className=className;

  }catch(err){
    info.textContent='Xəta: '+err.message;
    chart.textContent='—';
    signalEl.textContent='—';
    signalEl.className='neutral';
  }
}

runBtn.addEventListener('click',runOnce);
autoBtn.addEventListener('click',()=>{
  auto=!auto;
  autoBtn.textContent=auto?'Avto: açıq':'Avto: bağlı';
  if(auto){runOnce(); autoInterval=setInterval(runOnce,30000);} else clearInterval(autoInterval);
});
</script>
</body>
</html>


